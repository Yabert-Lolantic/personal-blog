8. The Spanning Tree Algorithm and Protocol

本节描述的配置算法和协议将桥接局域网拓扑简化为单个生成树

8.1 Requirements to be met by the algorithm
如第6条所述，生成树算法及其相关的桥接协议在所有方面支持、保存和维护MAC服务的质量。为了实现这一功能，算法需要满足以下要求，每一个要求都与该子句中的讨论有关：
	a)将任意拓扑结构的桥接局域网的活动拓扑配置为单个生成树，使任意两个端站之间最多有一条数据路由，消除数据环路(6.3.3；6.3.4)。
	b)在可用的网桥局域网组件范围内，通过自动重构由于网桥失效或数据通路中断而导致的生成树拓扑结构，实现容错，并自动适应添加到网桥局域网的任何网桥或网桥端口，而不形成瞬时数据环路（6.1）。
	c)整个主动拓扑将稳定在任何大小的桥接局域网。它将以很高的概率在一个短的、已知的有界区间内稳定下来，以便最小化任何一对终端站点之间的通信服务不可用的时间（6.1）。
	d)主动拓扑将是可预测和可重现的，并且可以通过管理算法的参数来选择，从而允许应用配置管理，在流量分析之后，以满足性能管理的目标(6.1；6.3.10)。
	e)它对终端站点是透明的，因此终端站点在使用MAC服务时不会知道自己连接到单个局域网或桥接局域网（6.2）。
	f)桥接器在任何特定局域网上建立和维护生成树所消耗的通信带宽只占总可用带宽的一小部分，并且独立于被桥接的局域网所支持的总流量，无论桥接器或局域网的总数是多少（6.3.10）。
	
此外，该算法和协议满足以下目标，从而限制了网桥及其配置的复杂性:
	g)与每个桥接端口相关的内存需求与桥接局域网中的桥接和局域网的数量无关。
	h)网桥在被添加到网桥的局域网之前，不需要单独配置，只需通过正常的过程分配其MAC地址。

8.2 Requirements of the MAC Bridges

为使桥接协议正常运行，需要满足以下条件。
	a)一个唯一的MAC组地址，由被桥接的局域网中的所有桥接器识别，它标识了连接到单个局域网的所有桥接器的桥接协议实体。
	b)每个网桥的标识符，在网桥局域网中是唯一的。
	c)每个桥接器端口有一个不同的端口标识符，可以独立于其他桥接器中使用的值分配。
	
每个桥接器都应提供这些参数的值，或为它们分配值的机制。对于使用48位通用管理地址的MAC网桥，唯一标识网桥协议实体的MAC地址是网桥组地址（7.12.3）。
另外，为了能够管理生成树活动拓扑的配置，还需要完成以下配置：
	1)在网桥局域网的网桥集合内分配每个网桥相对优先级的一种方法。
	2)为单个网桥的端口集合内的每个端口分配相对优先级的方法。
	3)为每个端口分配路径代价分量的方法。
	
当支持桥管理时，这些参数可以由管理层设置。
每个桥接器的唯一标识符部分来自桥接地址（7.12.5），部分来自可管理的优先级组件（9.2.5）。桥的相对优先级由唯一标识符的数值比较决定，数值越小优先级越高。
每个端口的标识符的一部分是固定的，并且对于网桥上的每个端口是不同的，另一部分是可管理的优先级组件（9.2.7）。端口的相对优先级由唯一标识符的数值比较决定，数值越小优先级越高。
与每个端口相关的路径成本是可以管理的。另外，8.10.2建议为连接到特定MAC类型和速度的局域网的端口设置默认值。

8.3 Overview
8.3.1 The active topology and its computation

生成树算法和协议从桥接局域网的任意连接组件中配置一个单连通的活动拓扑结构。
帧通过网桥局域网中的一些网桥端口转发，而不是通过处于阻塞状态的其他端口。在任何时候，桥接器都只有效地连接，端口处于转发状态的局域网。
帧通过处于转发状态的网桥端口进行双向转发。处于阻塞状态的端口不会在任何方向上转发帧，但可能被包含在活动拓扑中，即在组件失败、被删除或被添加时处于转发状态。

图7-1所示为网桥式局域网。图8-1展示了同一个网桥局域网经过配置后的活动拓扑，即逻辑连通性。

其中一个桥接器在桥接局域网中被称为根或根桥接器。每个单独的局域网都有一个桥接端口连接到它，它可以将来自该局域网的帧转发到根，也可以将根方向的帧转发到该局域网。
这个端口就是局域网的指定端口，它所在的网桥就是局域网的指定网桥。
根是所有它连接到的局域网的指定桥接器。每个网桥上处于转发状态的端口是根端口（离根最近的端口，见下文）和指定端口（如果有的话）。
没有被禁用的端口，既不是根端口也不是指定端口，不会将帧转发到它们所连接的局域网；这样的端口被称为备用端口。

在图8-1中，网桥1被选为根网桥（虽然从拓扑结构上看不出哪个是根网桥），并被指定为LAN A和LAN b的网桥。网桥2被指定为LAN C和LAN D的网桥，网桥4被指定为LAN e的网桥。图8-2显示了这种网桥LAN配置的逻辑树形拓扑。

桥接局域网的稳定主动拓扑由以下因素决定:
	a)与每个桥关联的唯一桥标识符。
	b)与各桥端口相关的路径成本。
	c)与每个网桥端口相关联的端口标识符

具有最高优先级桥标识符的桥是根（为了方便计算，这是具有最小数值的标识符）。
桥接局域网中的每个桥接端口都有一个与之相关联的根路径开销。这是每个桥接端口接收从根节点转发到桥接器的最小开销路径上的帧的路径开销之和。每个局域网的指定端口是根路径开销值最小的网桥端口：如果两个或多个端口的根路径开销值相同，则首先使用它们的网桥标识符，然后使用它们的端口标识符作为绑定限制。
这样，每个局域网只选择一个桥接端口作为指定端口，通过同样的计算从桥接器的自身端口中选择一个桥接器的根端口，就完全确定了桥接局域网的活动拓扑。

可以对每个网桥的网桥标识符、每个网桥端口的路径代价和端口标识符进行管理，从而允许管理器选择网桥局域网的活动拓扑。

8.3.2 Propagating the topology information

网桥向彼此发送一种称为配置BPDU的网桥协议数据单元，以通信和计算上述信息。传输BPDU的MAC帧在目的地址字段中携带网桥组地址，与该帧传输的局域网相连的所有网桥都会接收到该帧。
桥接协议数据单元不直接由桥接器转发，但其中的信息可以被桥接器用来计算它自己的BPDU进行传输，并可以刺激传输。
配置BPDU是在连接到单个局域网的桥接端口之间传递的，它与配置消息的概念不同，配置消息表示信息在桥接局域网中传播的过程。
配置BPDU的参数包括：传输桥认为是根的桥的唯一标识符、从传输端口到根的路径开销、传输桥的标识符和传输端口的标识符。
该信息足以使接收桥接器确定发送端口是否比当前认为是指定端口的端口更有资格成为收到配置BPDU的局域网上的指定端口，并确定接收端口是否应该成为桥接器的根端口（如果不是根端口）。

在整个网桥局域网中及时传播必要的信息，以允许所有网桥端口确定其状态（阻塞或转发），是通过以下三种基本机制实现的。
	a)一个相信自己是根的桥接器（所有桥接器开始时都相信自己是根接器，直到发现不是根接器）定期在它所连接的所有局域网上发送配置消息（通过发送配置bpdu）。
	b)桥接器接收到一个配置BPDU，它认为它的根端口传递了更好的信息（即，最高优先级的根标识符，最低的根路径成本，最高优先级的传输桥接器和端口），然后将该信息传递给它认为自己是指定桥接器的所有局域网。
	c)一个桥接器在它认为是它所连接的局域网上的指定端口上接收到劣质信息，并将自己的信息作为应答发送给连接到该局域网的所有其他桥接器。
因此，在整个桥接局域网中，可以快速学习到具有最高优先级根标识符的桥接器的生成树路径，而其他潜在根和路径的次等信息则相互矛盾。

8.3.3 Reconfiguration

为了在删除组件或对确定拓扑的参数进行管理更改时重新配置网桥局域网，在整个网桥局域网中传播的拓扑信息具有有限的生存期。
这是通过在每个配置BPDU中传递所传递信息的时间（配置消息从根节点发出后经过的时间）来实现的。
每个网桥都将来自其端口所连接的每个局域网上的指定端口的信息存储起来，并监视这些信息的时间。

在正常稳定运行的情况下，根节点定期发送配置消息，保证了拓扑信息不会超时。
如果桥接器为某个端口持有的信息超时，它将尝试成为该端口所连接的局域网的指定桥接器，并将从其根端口上的根接收到的协议信息传输到该局域网。
如果网桥的根端口超时，则可能会选择其他端口作为根端口。在网桥为指定网桥的局域网上传输的信息将根据在新根端口上接收到的信息计算。

如果没有来自当前根的信息记录，那么桥接器将通过声称是根本身来重新配置。如果根节点确实失败了，其他桥接器也会得到超时的协议信息；关于最佳后继节点和新的拓扑结构的信息将在桥接的局域网中迅速传播。
也有可能是到当前根节点的路径发生了变化，可能是由于开销增加，重新配置的桥接器超时了，因为桥接器认为来自根节点的最新信息较低，因为它的根路径开销更高。
在后一种情况下，相邻的桥接器将立即响应抱负根节点传输的bpdu。

为了确保桥接局域网中的所有桥接器对旧信息何时应该超时有共同的理解，超时时间值在从根发送的所有配置消息中传输。该值考虑了桥接局域网中每个局域网发送和接收bpdu的传播延迟，从而考虑了协议信息在生成树中的传播延迟。
为了最小化由于配置消息丢失而触发重新配置的概率，它包含了一个额外的时间间隔倍数，该时间间隔是根节点传输配置消息的时间间隔的倍数。

8.3.4 Changing Port State
由于在桥接局域网中传递协议信息时存在传播延迟，因此从一个活跃拓扑到另一个活跃拓扑不能有明显的过渡。
在网桥局域网的不同部分，拓扑变化可能在不同的时间发生，将从不参与的活跃拓扑的网桥端口直接移动到转发状态将有可能产生临时数据循环和帧的重复和乱序。
在开始转发帧之前，也希望其他桥接器有时间回复较差的协议信息。

因此，桥接端口在转发帧之前，必须等待新的拓扑信息在桥接的局域网中传播，并等待使用旧的主动拓扑转发的任何帧的帧生命周期到期。

在此期间，还希望对过滤数据库中可能不再真实的站点位置信息进行超时处理，并在此间隔的后半部分学习新的站点位置信息，以便在端口进入转发状态时最小化初始帧洪泛的影响。
因此，当算法决定一个端口应该进入转发状态时，它首先会进入侦听状态，等待协议信息提示它应该回到阻塞状态，并等待协议计时器到期，使它进入学习状态。在学习状态下，仍然阻塞帧的转发，但学习过程中学习到的站点位置信息被包含在过滤数据库中。
最后，协议定时器的到期使其进入转发状态，使中继帧的转发和站点位置信息的学习成为可能。
端口状态转换如图8-3所示。

8.3.5 Notifying topology changes
在正常稳定运行的情况下，过滤数据库中的台站位置信息只会因为台站的物理迁移而发生变化。因此，对过滤数据库中的条目采用较长的老化时间是可取的，特别是当许多终端站在搬迁后通电后发送帧，这将导致站的位置信息被重新学习。

然而，当网桥局域网的活跃拓扑结构重新配置时，终端站点可能从网桥的角度来看发生移动。即使网桥上的端口状态没有改变，也是如此。在活跃的拓扑结构发生变化后，即使只有部分桥接的局域网被重新配置，也有必要重新学习站点的位置。

生成树算法和协议提供了这样的过程：桥接器检测到活动拓扑中的变化，并可靠地通知根节点，然后根节点将变化通知所有的桥接器。然后桥接器使用一个短值将过滤数据库中的动态条目老化一段时间。

当不是根端口的桥接器改变了被桥接局域网的活动拓扑时，它会向其根端口所在的局域网发送拓扑改变通知BPDU。重复此传输，直到网桥收到来自该局域网的指定网桥的确认。
该确认在配置BPDU中携带，因此该通知最终将被确认或进行进一步的重新配置。指定的网桥使用相同的过程将通知传递给或传递给根节点。

如果根节点接收到这样的通知，或者改变了拓扑本身，它将在一段时间内传输的所有配置消息中设置一个拓扑改变标志。
此时，所有网桥都将收到一个或多个配置消息，否则将进行进一步的重新配置。设置该标志后，桥接器使用转发延迟（每个侦听和学习状态花费的时间间隔）的值来老化动态表项。当该标志再次重置时，桥接恢复到使用过滤数据库老化时间。

可以通过更改检测启用参数（8.5.5.10）在每个端口上启用或禁用检测拓扑变化的能力。此设施的目的是允许在已知连接了单个端站的端口上禁用拓扑变化检测，并且在启动和关闭该端站的电源时会触发拓扑变化通知机制的端口上禁用拓扑变化检测。
是否支持将此参数设置为禁用状态是可选的。

8.4 Port States

根据端口的状态和提供并支持桥接器操作（7.1）所需功能的进程（7.3）来描述单个桥接器端口的操作。
每个端口的状态负责处理从与该端口相关的MAC实体接收到的帧（7.5）、向该MAC实体提交帧以进行传输（7.6），以及可能将该端口包含在桥接局域网的活动拓扑中。
生成树算法和协议的操作是为了维护和改变每个端口的状态，以满足对算法的要求（8.1）。可能的端口状态和与帧处理相关的规则是本算法和网桥协议所特有的。

端口可能处于的5种状态（阻塞、侦听、学习、转发或禁用）分别定义如下。
	a)状态的目的。
	b)转发进程（7.7）是否丢弃收到的帧。
	c)转发进程（7.7）是否提交转发帧进行传输。
	d)学习过程如何处理接收到的帧（7.8）。
	e)桥接协议实体（7.10）是否在其计算活动拓扑时包括该端口。
	f)港口在何种条件下进入和离开该状态。

8.4.1 Blocking
处于该状态的端口不参与帧中继，从而避免了在桥接局域网的活跃拓扑中存在多条路径而导致的帧复制。
转发过程应丢弃收到的帧。不得提交转发的帧进行传输。学习过程中不应将站位信息添加到过滤数据库中。
桥接协议实体应在其主动拓扑计算中包括端口。收到的bpdu报文需要按照生成树算法和协议的要求进行处理。

此状态在网桥初始化之后进入，或者在通过管理操作使能端口时从禁用状态进入。通过生成树算法和协议的操作，可以从侦听、学习或转发状态进入该状态。一个端口进入阻塞状态，因为它收到信息，另一个网桥是为该端口所连接的局域网指定的网桥。
通过生成树算法和协议的操作，该状态可以在协议定时器到期或接收到该端口或其他端口的配置消息时保持，并进入侦听状态。
可以通过管理操作离开此状态，并进入禁用状态。

8.4.2 Listening 
处于此状态的端口准备参与帧中继。帧中继是暂时禁用的，以防止临时环路，在此状态的生命周期内，由于桥接局域网的活跃拓扑变化，可能发生在桥接局域网中。主动拓扑稳定后，主动拓扑的变化会导致获取的信息不正确，因此不能进行学习。
转发过程应丢弃收到的帧。不得提交转发的帧进行传输。学习过程中不应将站位信息添加到过滤数据库中。

桥接协议实体应在其主动拓扑计算中包括端口。收到的bpdu报文需要按照生成树算法和协议的要求进行处理。可以提交bpdu进行传输。
当生成树算法和协议的操作决定端口应该参与帧中继时，从阻塞状态进入此状态。
通过生成树算法和协议的操作，该状态可以在协议定时器到期时保持，并进入学习状态。通过生成树算法和协议的操作，在接收到本端口或另一个端口上的桥接协议数据单元时，可以保留此状态，并进入阻塞状态。通过管理操作，可以离开此状态，进入禁用或阻塞状态。

8.4.3 Learning
处于此状态的端口准备参与帧中继。帧中继是暂时禁用的，以防止临时环路，在此状态的生命周期内，由于桥接局域网的活跃拓扑变化，可能发生在桥接局域网中。学习允许在帧中继之前获取信息，以减少不必要的传输帧的数量。
转发过程应丢弃收到的帧。不得提交转发的帧进行传输。学习过程中需要将站点位置信息纳入过滤数据库。
桥接协议实体应在其主动拓扑计算中包括端口。收到的bpdu报文需要按照生成树算法和协议的要求进行处理。可以提交bpdu进行传输。

该状态由侦听状态通过生成树算法和协议的操作，在协议定时器到期时进入。
通过生成树算法和协议的操作，该状态可以在协议定时器到期时保持，并进入转发状态。通过生成树算法和协议的操作，在接收到本端口或另一个端口上的桥接协议数据单元时，可以保留此状态，并进入阻塞状态。通过管理操作，可以离开此状态，进入禁用或阻塞状态。

8.4.4 Forwarding
处于此状态的端口正在参与帧中继。
转发过程可以转发收到的帧。它可以提交转发的帧进行传输。学习过程中需要将站点位置信息纳入过滤数据库。
桥接协议实体应在其主动拓扑计算中包括端口。收到的bpdu报文需要按照生成树算法和协议的要求进行处理。可以提交bpdu进行传输。

通过生成树算法和协议的操作，在协议定时器到期时从学习状态进入该状态。
通过生成树算法和协议的操作，在接收到本端口或另一个端口上的桥接协议数据单元时，可以保留此状态，并进入阻塞状态。通过管理操作，可以离开此状态，进入禁用或阻塞状态。

8.4.5 Disabled
处于这种状态的端口不参与帧中继，也不参与生成树算法和协议的操作。
转发过程应丢弃收到的帧。不得提交转发的帧进行传输。学习过程中不应将站位信息纳入过滤数据库。
桥接协议实体不应将端口包括在其主动拓扑的计算中。生成树算法和协议不会对收到的bpdu进行处理。不得提交bpdu进行传输。
通过管理操作，可以从任何其他状态进入此状态。
当端口通过管理操作使能，并进入阻塞状态时，此状态将被保留。

8.5 Protocol parameters and timers
通过交换桥接协议数据单元，信息在各个桥接协议实体之间传递。该子句指定了指定的两种BPDU中传递的参数：
配置bpdu和拓扑变化通知bpdu。这些参数和附加信息元素的编码在第9条中指定。
每个桥接协议实体都维护独立于各个端口的若干参数和定时器，以及每个端口的若干定时器和参数。该子句指定了这些参数、它们的使用以及在什么条件下更新它们。

8.5.1 Configuration BPDU parameters
8.5.1.1 Root Identifier 
传输配置BPDU的网桥假定为根网桥的唯一网桥标识符。
传递这个参数是为了让所有桥接器对根节点达成一致。

8.5.1.2 Root Path Cost
从传输网桥到根网桥的路径开销，由根标识符表示。
传递此参数是为了使桥接器能够判断哪些连接到已收到配置BPDU的局域网的桥接器为该局域网提供了到根的最低开销路径。

8.5.1.3 Bridge Identifier
传输配置BPDU的网桥的唯一网桥标识符。
传递此参数是为了使网桥能够
a)决定，在局域网中，有两个或多个桥接器连接，它们提供到根节点的同等费用路径，哪一个桥接器应该被选为该局域网的指定桥接器。
b)检测同一网桥上的两个或多个端口连接到同一局域网的情况，即通过桥接的局域网组件的路径直接通信，且没有运行生成树算法和协议。

8.5.1.4 Port Identifier
发送配置BPDU的转发网桥端口号。该标识符唯一标识网桥上的端口。
传递此参数是为了使网桥能够决定，在局域网的情况下，同一网桥上的两个或多个端口连接到哪个端口，哪些端口是如此连接的。

8.5.1.5 Message Age
配置消息的年龄，是引导生成该配置BPDU的根节点生成该配置BPDU的时间。
传递此参数是为了使桥接器丢弃年龄超过最大年龄的信息（见下文）。

8.5.1.6 Max Age
由网桥局域网中的所有网桥使用的超时值。Max Age的值由根节点设置。
传递此参数是为了确保网桥局域网中的每个网桥具有一致的值，以便测试存储的配置信息的有效期。

8.5.1.7 Hello Time
根节点生成配置bpdu的时间间隔。
生成树算法不直接使用该参数，而是在配置bpdu中传递，方便管理功能对协议性能的监控。

8.5.1.8 Forward Delay
由网桥局域网中的所有网桥使用的超时值。转发延迟由根节点设置。
此参数的传递是为了保证网桥局域网中每个网桥在将端口状态转换为转发状态时使用一致的Forward Delay Timer值。该参数也用于在活跃拓扑变化时老化过滤数据库动态表项的超时值。

8.5.1.9 Topology Change Acknowledgment
在配置消息中设置的标志，用于响应在指定端口上收到的拓扑变化通知。传递此参数是为了允许可靠的确认协议操作，以通知活跃拓扑的变化。

8.5.1.10 Topology Change
根节点在一段时间内在所有配置中设置的标志。在通知或检测到拓扑变化后发送的bpdu。

传递此参数是为了通知整个桥接局域网的桥接者，即部分桥接局域网的活动拓扑发生了变化，并且过滤数据库应该更快地淘汰条目，以限制由于在过滤数据库中使用不正确的信息而导致连接到桥接局域网的端系统的临时隔离的影响。
过滤数据库中动态表项的老化时间与为桥梁保存的前向延迟时间参数的值相等；也就是说，在前向延迟时间过去之后，在从根节点接收到的所有配置消息中设置了拓扑变化标志，那么过滤数据库中只剩下那些在此期间创建或更新的动态条目。

8.5.2 Topology Change Notification BPDU parameters
在拓扑变更通知BPDU中不传递任何参数

8.5.3 Bridge parameters
8.5.3.1 Designated Root

假定为根的桥接器的唯一标识符。
在所有配置中，此参数都用作桥接器传输的bpdu的根标识参数的值。

8.5.3.2 Root Path Cost
从这座桥到根的路的费用。当桥接器是根时，此参数的值为0。否则，它等于根端口的指定开销值和路径开销参数值的总和。该参数用于测试接收到的配置消息信息中传递的根路径开销参数的值，以及作为发送的配置消息信息中的根路径开销参数的值。

8.5.3.3 Root Port
提供到根节点最低成本路径的端口的标识符，即该端口的指定成本值和路径成本参数的总和是最低的。
如果两个或多个端口提供了到根的相同的最小开销路径，根端口将被选择为具有最高优先级桥标识符的端口，该标识符作为该端口的指定桥参数。
如果两个或多个端口提供相同的最小开销路径到根端口，并且拥有相同的指定桥接参数值，那么根端口将被选择为拥有该端口最高优先级指定端口的端口。
最后，如果两个或多个端口提供到根端口的相同的最小开销路径，并且具有相同的指定网桥和指定端口参数值，则根端口将被选择具有最高优先级端口标识的端口。同一网桥上的不同端口的端口标识符保证是不同的，从而实施平局断路器。
此参数用于标识建立到根目录的路径所通过的端口。当桥接器是根节点时，该值不重要，设置为0。

8.5.3.4 Max Age
接收到的协议信息被丢弃前的最大时间。

8.5.3.5 Hello Time
试图成为根节点或已经是根节点的桥接器发送配置bpdu的时间间隔。

8.5.3.6 Forward Delay
端口从侦听状态变为学习状态所花费的时间，从学习状态变为转发状态所花费的时间。它也是过滤数据库中动态条目的老化时间值，而接收到的配置消息表示拓扑变化。

8.5.3.7 Bridge Identifier
桥的唯一标识符。此参数用作的值
a)所有配置中的网桥标识参数。
b)桥接器的指定根，当桥接器是根，或试图成为根，在有关当前根的所有信息到期后，或在管理操作之后。
该参数由两部分组成，一部分来自唯一网桥地址（7.12.5），保证网桥局域网中网桥标识的唯一性，另一部分允许调整网桥标识的优先级，在优先级比较中起更重要的作用。当支持桥接管理时，该参数的优先级部分可以通过管理操作进行更新。

8.5.3.8 Bridge Max Age
当网桥是根节点或试图成为根节点时，Max Age参数的值。
当支持网桥管理时，此参数可以根据管理动作进行更新。

8.5.3.9 Bridge Hello Time
桥接器是根节点或试图成为根节点时，Hello Time参数的值。
当桥接器试图将拓扑变化通知其根端口所附接的LAN上的指定桥接器时，此参数表示向根端发送拓扑变化通知bpdu的时间间隔。
当支持网桥管理时，此参数可以根据管理动作进行更新。

8.5.3.10 Bridge Forward Delay 
前向延迟参数的值，当网桥是根节点或试图成为根节点时。
当支持网桥管理时，此参数可以根据管理动作进行更新。

8.5.3.11 Topology Change Detected
布尔参数，设置为True，表示桥检测到拓扑变化或通知桥。当设置为True时，此参数用于在桥本身不是根节点时，刺激向根节点发送拓扑变化通知；并将桥的拓扑变化参数的值设置为True，如果桥是或成为根桥。
传输受可靠的确认机制约束，如8.3.5和8.5.1.9；拓扑变化通知bpdu以桥接Hello时间为固定间隔发送，直到被确认。

8.5.3.12 Topology Change
设置为record的布尔参数
	a)对于不是根桥接器的桥接器，最近接受的配置消息是否表明活动拓扑发生了变化；或
	b)对于根节点，在上述拓扑变化时间段内是否检测到拓扑变化。
此参数用于在传输的配置消息中传播拓扑变化的指示，并确定对过滤数据库中的动态条目使用短（前向延迟）或长（老化时间）超时值。

8.5.3.13 Topology Change Time
在检测到拓扑变化后，网桥发出指示拓扑变化的配置消息的时间周期，此时网桥是根。该参数的值等于桥梁的桥龄最大值和桥前向延迟参数的值之和。

8.5.3.14 Hold Time
通过一个给定的LAN端口传输配置BPDU的最小时间间隔：在任何保持时间内最多传输一个配置BPDU。该参数为固定参数，取值如表8-3所示。

8.5.4 Bridge timers
8.5.4.1 Hello Timer
该定时器用于确保桥接器在成为或试图成为根节点时周期性地传输配置bpdu。
定时器的超时值是桥的Bridge Hello Time参数的超时值。

8.5.4.2 Topology Change Notification Timer
此定时器用于确保在检测到任何拓扑变化时，桥接器根端口所附接的LAN上的指定桥接器得到通知。
定时器的超时值是桥的Bridge Hello Time参数的超时值。

8.5.4.3 Topology Change Timer
该定时器用于确定桥接器在检测到拓扑变化后，桥接器设置了拓扑变化标志，在多长时间内发送配置bpdu。
定时器的超时值为桥的拓扑变化时间参数值。

8.5.5 Port parameters
8.5.5.1 Port Identifier
端口的标识符，在此网桥的端口中是唯一的。此参数用作所有通过该端口传输的配置消息的端口标识参数的值。
参数由两部分组成。一部分与现实世界的设备对港口的物理或逻辑支持具有固定的关系；该部分保证了端口标识在单个网桥的端口之间的唯一性，是一个在1以上范围内分配的小整数。参数的另一部分允许调整端口的优先级，在优先级比较中被视为更重要的部分。
当支持桥管理时，该参数的优先级部分可以由管理层进行更新。

8.5.5.2 State
端口的当前状态（禁用、侦听、学习、转发或阻塞）。
该参数用于控制转发和学习进程接收端口关联的MAC实体发送的帧，转发进程向该MAC实体转发帧，以及bpdu的发送和接收（8.4）。
这个参数会随着协议的变化而更新。
当支持桥接管理时，此参数也可以通过管理操作进行更新。

8.5.5.3 Path Cost 
当端口是根端口时，通过该端口的路径对桥接器到根端口路径的总开销的贡献。
该参数与根端口的指定Cost参数的值相加，作为桥接器传输的所有配置bpdu中提供的根路径Cost参数的值。
当支持网桥管理时，此参数可以通过管理动作进行更新。

8.5.5.4 Designated Root
在配置的根标识参数中作为根记录的网桥的唯一标识。该端口所连接的局域网由指定网桥传输的bpdu。
该参数用于测试接收到的配置bpdu中传递的根标识符参数的值。

8.5.5.5 Designated Cost
	a)对于一个指定端口，提供给该端口所连接的局域网的路径开销（等于网桥的根路径开销）；否则,
	b)该端口所连接的局域网上的指定端口提供到根节点的路径的开销。
该参数用于测试接收到的配置bpdu报文中传递的根路径代价参数的值。

8.5.5.6 Designated Bridge 
的唯一网桥标识符（8.5.3.7）
	a)如果是指定港口，港口所属的桥架；或以其他方式,
	b)被认为是该端口连接到的局域网的指定桥接器。
已使用此参数。
	c)连同该端口的指定端口和端口标识参数，以确定该端口是否为该端口所附接的局域网的指定端口。
	d)测试收到的配置bpdu中传递的网桥标识参数的值。

8.5.5.7 Designated Port
网桥端口的端口标识（8.5.5.1），在指定网桥（8.5.5.6）上，指定网桥通过该端口传递存储在该端口上的配置消息信息。
已使用此参数。
a)连同指定的网桥和端口标识参数，以确定该端口是否应为它所附接的局域网的指定端口。
b)由管理层确定桥接局域网的拓扑结构。

8.5.5.8 Topology Change Acknowledge 
在关联端口上传输的下一个配置BPDU中拓扑变化确认标志的值。
此参数用于记录收到拓扑变化通知BPDU后，需要在应答时设置拓扑变化确认标志。

8.5.5.9 Configuration Pending 
布尔参数，用来记录在相关端口的保持定时器到期时发送配置BPDU。
该参数与端口的保持定时器配合使用，以确保配置bpdu的传输不会过于频繁，而是传输最新的信息。

8.5.5.10 Change Detection Enabled
布尔参数，用于记录是否为关联端口启用拓扑变化检测。如果禁用了变化检测，从将拓扑变化通信到根节点的角度来看，桥接器检测到的拓扑变化或通过该端口通知到桥接器的拓扑变化将被忽略。
对于网桥的所有端口，此参数的默认状态应为启用。是否支持将此参数设置为禁用状态是可选的。

8.5.6 Port timers
8.5.6.1 Message Age Timer
该定时器用于测量接收到的端口记录的协议信息的年龄，并确保当该信息的年龄超过桥端记录的最大年龄参数值时，该信息将被丢弃。
定时器的超时值是桥的最大Age参数的值。

8.5.6.2 Forward Delay Timer
该定时器确定端口侦听和学习状态所花费的时间。定时器的超时值为桥的前向延迟参数的值。

8.5.6.3 Hold Timer
该定时器用于确保配置bpdu不会通过桥接端口过于频繁地传输。
定时器的超时值为桥保持时间。

8.6 Elements of procedure
8.6.1 Transmit Configuration BPDU
8.6.1.1 Purpose
将指定根、根路径开销、指定桥接器、指定端口和协议定时器的值传递给与传输配置BPDU的端口连接到同一局域网的其他桥接器端口。

8.6.1.2 Use
a)案例1。作为配置BPDU生成过程（8.6.4）的一部分。
b)案例2。作为对配置BPDU过程（8.6.5）的应答的一部分。
c)答案3。在端口的保持定时器到期之后（8.7.8），此时设置了端口的Configuration Pending标志参数，这是该过程之前调用的结果。
d)答案4。作为确认拓扑更改过程的一部分（8.6.16）。

8.6.1.3 Procedure
8.6.1.3.1 Step 1
如果端口的保持定时器是活动的，那么端口的配置未决标志参数将被设置。这就完成了整个过程。否则，如果保持定时器不活动，则调用下列步骤。

8.6.1.3.2 Step 2
如果端口的保持定时器未激活，则为发送配置BPDU做好准备。配置BPDU应设置如下参数：
a)根标识符设置为桥接器持有的指定根参数的值。
b)根路径代价设置为桥所持有的根路径代价参数的值。
c)桥架标识应设置为桥架持有的桥架标识参数的值。
d)端口标识设置为传输配置BPDU所通过的桥接端口的端口标识参数的值。
e)如果已经选择了桥接器作为根，即指定的根与桥接器所持有的桥接器标识符参数值相同，则消息age设置为零。
f)否则，设置消息age的值，使传输的配置BPDU不传递在根端口上接收到的协议消息的age的低估值；即，传输的值应不小于该端口的消息时间定时器记录的值，应大于接收的值，并将包含任何传输延迟。
该参数的值不能超过其真实值超过8.10.2中规定的最大消息时间增量的高估。
g)最大age、Hello时间和前向延迟应设置为桥保持的最大年龄、Hello时间和前向延迟参数的值。
h)拓扑改变确认标志设置为该端口的拓扑改变确认标志参数值。
i)拓扑改变标志设置为桥架拓扑改变标志参数的值。

8.6.1.3.3 Step 3
如果配置BPDU中Message Age参数的值小于Max Age参数的值，则
a)重置端口的拓扑变化确认标志参数。
b)重置端口的配置未决标志参数。
c)BPDU通过端口的传输时间应在BPDU最大传输延迟时间内完成（规定在8.10.2）。
d)启动端口的保持定时器。

8.6.2 Record Configuration Information
8.6.2.1 Purpose 
记录端口接收到的配置BPDU所传递的协议参数。

8.6.2.2 Use
在接收到传递协议信息的配置BPDU之后，即if
a)案例1。根标识符表示一个比记录为指定根或更高优先级的桥接器
b)案例2。根标识符与指定根相同，且根路径开销低于记录为该端口的指定开销
c)答案3。根标识符和根路径开销记录在端口上，网桥标识符表示一个比记录为该端口的指定网桥（or）优先级更高的网桥
d)答案4。根标识符和根路径开销为该端口记录的值，网桥标识符为该端口记录的指定网桥标识符
	1)接收BPDU的网桥不是指定的端口网桥，或者
	2)端口标识符表示一个优先级不低于记录为指定端口的端口。

8.6.2.3 Procedure
8.6.2.3.1 Step 1
配置本端口持有的指定根（Designated Root）、指定代价（Designated Cost）、
指定桥（Designated Bridge）和指定端口（Designated Port）参数为收到的配置BPDU中传递的根标识符（Root Identifier）、
根路径代价（Root Path Cost）、桥标识符（Bridge Identifier）和端口标识符（Port Identifier）的值。

8.6.2.3.2 Step 2
启动端口的Message Age定时器，根据收到的配置BPDU中传递的Message Age参数值运行。

8.6.3 Record Configuration Timeout Values
8.6.3.1 Purpose
将Max Age、Hello Time、Forward Delay和Topology Change标志参数更新为从根节点接收到的最新值。

8.6.3.2 Use
在根端口上收到配置BPDU，调用记录配置信息过程（8.6.2.2）。

8.6.3.3 Procedure
将桥接器保持的Max Age、Hello Time、Forward Delay和拓扑变化参数设置为收到的配置BPDU中的值。

8.6.4 Configuration BPDU Generation
8.6.4.1 Purpose
将指定的根、根路径代价、指定的桥接器、指定的端口和协议定时器的值等信息传递给连接到指定桥接器的每个局域网的桥接器。

8.6.4.2 Use
a)案例1。在根端口上收到配置BPDU后调用记录配置信息过程（8.6.2.2）。
b)案例2。在Hello定时器到期之后。
c)答案3。在网桥端口的消息老化定时器到期时，通过配置更新过程选择网桥作为指定的根。
d)答案4。随后选择网桥作为指定的根管理行动。

8.6.4.3 Procedure
对于每个端口，如果它是LAN的指定端口（即该端口的指定网桥和指定端口参数的值分别与未处于禁用状态的网桥标识符和端口标识符相同），则使用Transmit Configuration BPDU过程（8.6.1）。

8.6.5 Reply to Configuration BPDU
8.6.5.1 Purpose
在另一个网桥端口已经在该局域网上传输了配置BPDU的情况下，为局域网建立指定网桥和指定端口。
如果发送桥接器没有接收到来自当前根的配置消息，则会发生这种情况，原因可能是新建立了根，也可能是BPDU丢失或消息时间定时器随后到期。

8.6.5.2 Use
在一个端口上收到配置BPDU后，该端口是它所附接的局域网的指定端口，但该端口不更新为该端口保存的信息，即不满足使用配置信息记录过程的条件（8.6.2.2）。

8.6.5.3 Procedure
Transmit Configuration BPDU过程（8.6.1）用于接收配置BPDU的端口。

8.6.6 Transmit Topology Change Notification BPDU
8.6.6.1 Purpose
通知通往根路径上的桥接器，传输桥接器检测到拓扑的扩展。最终，这将导致根节点收到拓扑更改的通知。

8.6.6.2 Use
a)案例1。在不是根桥接器的桥接器检测到或接收到拓扑更改通知之后。
b)案例2。在拓扑变化通知定时器到期之后。

8.6.6.3 Procedure
拓扑变化通知BPDU必须在最大BPDU传输延迟时间（8.10.2）内通过根端口传输。

8.6.7 Configuration Update
8.6.7.1 Purpose
更新网桥和网桥端口的配置信息。

8.6.7.2 Use
a)案例1。收到配置BPDU后调用记录配置信息过程（8.6.2.2）。
b)案例2。在端口的消息时间定时器到期时，该端口将成为其附加到的局域网的指定端口。
c)答案3。通过管理操作跟踪端口状态的变化。

8.6.7.3 Procedure
8.6.7.3.1 Step 1
根选择过程（8.6.8）应使用选择指定的根和根端口，并计算该桥的根路径代价。

8.6.7.3.2 Step 2
指定端口选择的过程（8.6.9）应使用确定每个端口是否应该成为它所附接的局域网的指定端口。

8.6.8 Root selection
8.6.8.1 Purpose
选择指定的根和根端口，并计算此桥的根路径开销。

8.6.8.2 Use
本步骤用于配置更新过程（8.6.7）。

8.6.8.3 Procedure
8.6.8.3.1 Step 1
根端口被设置为标识在那些不是它们所连接的局域网的指定端口中没有被禁用的端口，并且具有比桥接器的桥接标识符更高优先级的指定Root参数的端口；
a)具有与其相关联的最高优先级根，即记录为该端口的指定根。
b)具有最高优先级的指定根参数的两个或多个端口，其所关联的根路径代价最小，即指定代价与路径代价参数之和最小；或
c)具有最高优先级指定根参数和最低关联根路径代价值的两个或多个端口，具有最高优先级的网桥标识符，记录为该端口所连接的局域网的指定网桥；或
d)具有最高优先级的指定根参数、最低的关联根路径成本值和最高优先级的指定桥的两个或多个端口，具有最高优先级的端口标识符记录为该端口所连接的局域网的指定端口；或
e)具有最高优先级的指定根参数、最低的关联根路径成本值、最高优先级的指定桥和指定端口的两个或多个端口，具有最高优先级的端口标识。

8.6.8.3.2 Step 2
如果没有根端口，则根端口参数的值设置为0
a)网桥保存的指定根参数设置为网桥保存的网桥标识符参数，以及
b)桥接器持有的根路径代价参数值设置为0。

8.6.8.3.3 Step 3
否则，即如果其中一个网桥端口被标识为根端口，则
a)桥接器保存的指定根参数设置为根端口保存的指定根参数，以及
b)桥接器保存的根路径代价参数值设置为根端口关联的根路径代价参数值，即为根端口记录的路径代价值与指定的代价参数值之和。

8.6.9 Designated Port selection
8.6.9.1 Purpose
来确定每个端口是否应该是它所附接的局域网的指定端口。

8.6.9.2 Use
作为配置更新过程（8.6.7）的一部分。

8.6.9.3 Procedure
成为指定端口（8.6.10）的程序应针对下列每个端口调用
a)已经被选为它所附接的局域网的指定端口，即为该端口保存的指定网桥和指定端口参数的值分别与该端口的网桥标识符和端口标识符相同，或与该端口相同
b)桥接器记录的指定根参数与端口记录的指定根参数不同（注意，此过程遵循根选择）；c)桥接器为连接端口的局域网提供了一条到根节点的低成本路径，即桥接器记录的根节点路径成本小于端口记录的指定根节点路径成本
d)桥接器提供一条到根节点代价相等的路径，并且桥接器的桥标识符表示一个优先级高于记录为该端口指定的桥接器的桥接器，或
e)网桥提供一条到根节点相等代价的路径，网桥是端口所在局域网的指定网桥，端口的端口标识比记录为指定端口的端口标识具有更高的优先级。

8.6.10 Become Designated Port
8.6.10.1 Purpose
给定一个端口是LAN上它所附接的指定端口，为那些决定桥接LAN的活动拓扑的端口参数分配适当的值。

8.6.10.2 Use
a)案例1。在端口的消息时间定时器到期之后。
b)案例2。随后将该端口选择为LAN的指定端口，它通过指定端口选择过程（8.6.9）作为配置更新过程（8.6.7）的一部分附加到该LAN。
3.答案c。通过管理动作（8.8.1、8.8.2、8.8.3和8.8.5）改变端口状态。

8.6.10.3 Procedure
a)为端口保存的指定根参数设置为桥接器保存的指定根参数的值；
b)为端口保存的指定代价参数设置为桥接器保存的根路径代价值；
c)为端口保存的指定桥参数设置为桥的桥标识符；
d)端口的指定端口参数设置为端口的端口标识符。

8.6.11 Port State selection
8.6.11.1 Purpose
根据更新的配置信息选择网桥端口的状态，该配置信息表示每个端口在网桥局域网的活跃拓扑中所占的部分，即是否应该这样做
a)作为网桥的根端口。
b)成为指定港口。
c)作为备用端口，即在冗余连接的网桥局域网中作为备份端口。

8.6.11.2 Use
后续使用的配置更新程序
a)案例1。接收配置BPDU，传送取代端口记录的信息。
b)案例2。某个端口的消息老化定时器到期，该端口将成为它所连接的局域网的指定端口。
c)答案3。由于管理操作而引起的端口状态的变化。

8.6.11.3 Procedure
对于网桥的每个端口：
a)如果端口是桥接器的根端口，则
	1)重置端口的“Configuration Pending flag”参数和“Topology Change Acknowledge flag”参数。
	2)对端口使用Make Forwarding过程（8.6.12）。
b)否则，如果该端口是其所附局域网的指定端口，即该端口的指定网桥参数与网桥持有的网桥标识符参数相同，且该端口持有的指定端口和端口标识符参数相同且该端口不处于禁用状态，则
	1)如果端口的消息时间定时器正在运行，则停止。
	2)对端口使用Make Forwarding过程（8.6.12）。
c)否则，如果端口是备用端口，即既不是根端口也不是指定端口，则
	1)重置端口的“Configuration Pending flag”参数和“Topology Change Acknowledge flag”参数。
	2)使用了阻塞（8.6.13）的过程。

8.6.12 Make forwarding
8.6.12.1 Purpose
允许一个端口参与帧中继，遵循适当的间隔，以确保桥接局域网中的临时环路不会造成帧的重复。

8.6.12.2 Use
作为端口选择程序（8.6.11）的一部分。

8.6.12.3 Procedure 
如果端口状态为阻塞，则
	a)端口状态设置为侦听，并且
	b)启动端口的前向延迟定时器。

8.6.13 Make blocking
8.6.13.1 Purpose
终止某个端口在帧中继中的参与

8.6.13.2 Use
作为端口状态选择程序的一部分（8.6.11）。

8.6.13.3 Procedure
如果端口没有处于禁用或阻塞状态，则
a)如果端口处于“转发”或“学习”状态，并且设置了端口的变化检测使能参数，则调用拓扑变化检测程序（8.6.14）；
b)该端口的端口状态设置为阻塞；
c)端口前向延迟定时器停止。

8.6.14 Topology change detection
8.6.14.1 Purpose
记录桥接器检测到的拓扑变化或通知到桥接器的拓扑变化，并发起操作，将检测到拓扑变化的事实通知到根节点。

8.6.14.2 Use
8.6.14.2.1 Case 1
在接收到拓扑变化通知时，端口上的BPDU是该端口所附接的局域网的指定端口。

8.6.14.2.2 Case 2
当网桥端口在该端口的前向延迟定时器过期后进入转发状态时，前提是设置了该端口的变化检测启用参数，并且网桥是其端口连接到的至少一个局域网的指定网桥。

8.6.14.2.3 Case 3
当桥接端口处于转发或学习状态时变为阻塞状态，前提是该端口设置了变化检测使能参数。

8.6.14.2.4 Case 4
当桥变成根。

8.6.14.3 Procedure
a)如果已选择桥接器为根，即为桥接器保存的指定根和桥接器标识符参数相同，则
	1)设置网桥的拓扑变化标志参数。
	2)启动桥的拓扑变化定时器。
b)如果桥没有被选择为根，并且桥的拓扑变化检测标志参数没有设置，则
	1)调用Transmit Topology Change Notification BPDU过程（8.6.6）。
	2)启动拓扑变化通知定时器。
c)设置了桥的拓扑变化检测标志参数。

8.6.15 Topology change acknowledged
8.6.15.1 Purpose
终止拓扑变化通知bpdu报文的传输。

8.6.15.2 Use
在接收到根端口连接到的LAN的指定桥接器所设置的带有拓扑更改确认标志参数的配置BPDU之后。

8.6.15.3 Procedure
a)复位桥保存的拓扑变化检测标志参数；
b)拓扑变化通知定时器停止。

8.6.16 Acknowledge topology change
8.6.16.1 Purpose
确认由另一个网桥检测到的拓扑变化通知。

8.6.16.2 Use
在接收到一个端口上的拓扑变化通知BPDU后，该端口是它所连接到的局域网的指定端口。

8.6.16.3 Procedure
a)设置了端口的拓扑变化确认标志参数；
b)端口使用Transmit Configuration BPDU过程（8.6.1）。

8.7 Operation of the protocol
桥接协议实体应
a)通过传输桥接协议数据单元与其他桥接器中的对等实体进行通信；
b)更新存储的协议变量和定时器；
c)改变桥接端口状态；
后
-桥接协议数据单元的接收；
-网桥和端口定时器的到期；

按以下规范要求（8.7.1、8.7.2、8.7.3、8.7.4、8.7.5、8.7.6、8.7.7和8.7.8）。如有歧义，应参考程序模式（8.9），该模式构成议定书运作的确定说明。

本规范使用了8.6中描述的协议的过程要素，加上本子句以及8.5中描述的协议参数和定时器，提供了生成树算法和协议的抽象描述。通过维护协议参数和定时器以及上述bpdu的传输，可以实现与该规范的一致性。实现不受其他约束；特别是，没有遵守程序的个别组成部分。

8.7.1 Received Configuration BPDU
8.7.1.1 Case 1
如果接收到的配置BPDU传递的协议信息取代了8.6.2.2中指定的端口已经持有的协议信息，那么将依次使用下列过程：
a)步骤1。记录配置信息流程（8.6.2）。
b)第二步。配置更新步骤（8.6.7）。
c)步骤3。端口状态选择过程（8.6.11）。
d)第四步。如果桥接器在配置更新之前被选为根节点，但现在不再是根节点，那么Hello定时器（8.5.4.1）将停止。
e)第五步。如果在配置更新前选择该桥接器为根，但该桥接器不再是根接器，并且设置了拓扑变化检测标志参数，则停止拓扑变化定时器，使用发送拓扑变化通知BPDU程序（8.6.6），启动拓扑变化通知定时器。
f)步骤6。如果配置BPDU是在根端口（即被配置更新过程选择为根端口的端口）上收到的，则使用记录配置超时时间（8.6.3）和配置BPDU生成（8.6.4）过程。
g)第七步。如果在根端口上收到配置BPDU，并且设置了拓扑变化确认标志参数，则使用拓扑变化确认过程（8.6.15）。

8.7.1.2 Case 2
如果接收到的配置BPDU不传递取代已为该端口保存的信息，并且该端口是其所附接的局域网的指定端口，即为该端口保存的指定网桥和指定端口参数的值分别与网桥的网桥标识符和该端口的端口标识符相同，则使用应答配置BPDU过程（8.6.5）。

8.7.2 Received Topology Change Notification BPDU
如果收到拓扑变化通知BPDU的端口是该端口所连接的LAN的指定端口，则
a)步骤1。使用拓扑变化检测程序（8.6.14）。
b)第二步。使用“确认拓扑变更流程”（8.6.16）。

8.7.3 Hello Timer expiry
使用配置BPDU生成过程（8.6.4），并启动Hello定时器（8.5.4.1）。

8.7.4 Message Age Timer expiry
a)步骤1。成为指定端口的过程（8.6.10）用于消息时间定时器已过期的端口。
b)第二步。使用配置更新流程（8.6.7）。
c)步骤3。使用端口状态选择程序（8.6.11）。
d)第四步。如果在配置更新后选择网桥作为根，则
	1)步骤1。桥接器保持的Max Age、Hello Time和Forward Delay参数值为桥接器Max Age、桥接器Hello Time和桥接器Forward Delay的值。
	2)第二步。使用拓扑变化检测程序（8.6.14）。
	3)第三步。拓扑变更通知定时器（8.5.4.2）停止。
	4)第四步。使用配置BPDU生成过程（8.6.4），并启动Hello定时器。

8.7.5 Forward Delay Timer expiry
a)步骤1。如果前向延迟定时器（8.5.6.2）过期的端口正在监听，则
	1)步骤1。端口状态设置为Learning和
	2)第二步。重启前向延迟定时器。
b)第二步。否则，如果前向延迟定时器（8.5.6.2）过期的端口状态是Learning，则
	1)步骤1。端口状态设置为转发和
	2)第二步。如果网桥是其端口所附接的至少一个局域网的指定网桥，并且为该端口设置了变化检测启用参数，则调用拓扑变化检测程序（8.6.14）。

8.7.6 Topology Change Notification Timer Expiry
a)步骤1。使用发送拓扑变化通知BPDU程序（8.6.6）。
b)第二步。重新启动拓扑变更通知定时器（8.5.4.2）。

8.7.7 Topology Change timer
a)步骤1。复位网桥保存的拓扑变化检测标志参数。
b)第二步。重置网桥持有的拓扑变化标志参数。

8.7.8 Hold Timer expiry
如果设置了保持定时器（8.5.6.3）已过期的端口的Configuration Pending标志参数，则对该端口调用Transmit Configuration BPDU过程（8.6.1）。

8.8 Management of the Bridge Protocol Entity
对操作生成树算法和协议的桥接协议实体进行管理控制，以达到对生成树算法和协议进行管理的目的
	—满足本地信息和配置服务的各种需求。
	—支持管理操作。
该子句指定了下列管理操作与生成树算法和协议的参数和过程的交互：
a)初始化;
b)启用单个端口；
c)禁用单个端口；
d)改变桥标识符的优先级部分；
e)改变端口标识符的优先级部分；
f)改变与单个港口相关的路径成本；
g)启用或禁用与单个端口关联的拓扑变化检测。

这些操作将修改协议参数和定时器，并传输bpdu，如下所述（8.8.1、8.8.2、8.8.3、8.8.4、8.8.5、8.8.6、8.8.7和8.8.8）。实现不受其他约束；特别是，没有遵守程序的个别组成部分。如有歧义，应参考程序模式（8.9），该模式构成这些行动的明确描述。

本子句不指定哪些操作对远程管理站可用，也不指定这些操作如何组合和传送。可由远程管理提供的操作和设施详见第14条。类似地，该子句不指定本地信息和配置过程的可用性。

8.8.1 Initialization
a)步骤1。桥接器的指定根参数设置为桥接器标识符的值，桥接器的根路径代价和根端口参数设置为0。
b)第二步。桥接器保持的Max Age、Hello Time和Forward Delay参数值为桥接器Max Age、桥接器Hello Time和桥接器Forward Delay的值。
c)步骤3。重新检测到桥的拓扑变化和拓扑变化标志参数，如果运行，则停止拓扑变化通知定时器（8.5.4.2）和拓扑变化定时器（8.5.4.3）。
d)第四步。桥的每个端口
	1)步骤1。成为指定端口过程（8.6.10）用于为端口分配指定根、指定成本、指定网桥和指定端口参数的值。
	2)第二步。如果端口在初始化后要启用，则端口状态设置为阻塞；或者，端口状态设置为“禁用”。
	3)第三步。重置拓扑变化确认标志参数。
	4)步骤4重置配置待决标志参数。
	5)第五步。如果消息年龄定时器（8.5.6.1）正在运行，则停止。
	6)第六步。如果前向延迟定时器（8.5.6.2）正在运行，则停止。
	7)步骤7。如果保持定时器（8.5.6.3）正在运行，则停止。
	8)第八步。设置变化检测使能标志（8.5.5.10）。
e)第五步。端口状态选择过程（8.6.11）用于选择每个网桥端口的状态。
f)步骤6。调用配置BPDU生成过程（8.6.4），并启动Hello定时器（8.5.4.1）。

8.8.2 Enable Port
a)步骤1。成为指定端口过程（8.6.10）用于为端口分配指定根、指定成本、指定网桥和指定端口参数的值。
b)第二步。端口状态设置为阻塞。
c)步骤3。重置拓扑变化确认标志参数。
d)第四步。重置配置未决标志参数。
e)第五步。如果消息年龄定时器（8.5.6.1）正在运行，则停止。
f)步骤6。如果前向延迟定时器（8.5.6.2）正在运行，则停止。
g)第七步。如果保持定时器（8.5.6.3）正在运行，则停止。
h)步骤8。使用端口状态选择程序（8.6.11）。

8.8.3 Disable Port
a)步骤1。成为指定端口过程（8.6.10）用于为端口分配指定根、指定成本、指定网桥和指定端口参数的值。
b)第二步。端口状态设置为“禁用”。
c)步骤3。重置拓扑变化确认标志参数。
d)第四步。重置配置未决标志参数。
e)第五步。如果消息年龄定时器（8.5.6.1）正在运行，则停止。
f)步骤6。如果前向延迟定时器（8.5.6.2）正在运行，则停止。
g)第七步。使用配置更新流程（8.6.7）。
h)步骤8。使用端口状态选择程序（8.6.11）。
i)第9步。如果桥接器在配置更新后被选择为根，则
	1)步骤1。桥接器保持的Max Age、Hello Time和Forward Delay参数值为桥接器Max Age、桥接器Hello Time和桥接器Forward Delay的值。
	2)第二步。使用拓扑变化检测程序（8.6.14）。
	3)第三步。拓扑变更通知定时器（8.5.4.2）停止。
	4)第四步。使用配置BPDU生成过程（8.6.4），并启动Hello定时器。

8.8.4 Set Bridge Priority
a)步骤1。计算桥接标识符的新值。
b)第二步。每个端口的指定网桥参数的值，该端口已被选为它所附接的局域网的指定端口(即，其指定网桥和指定端口参数的值分别与该端口的网桥标识符和端口标识符相同；设置为桥标识符的新值。
c)步骤3。网桥保存的网桥标识符参数被设置为新的值。
d)第四步。使用配置更新流程（8.6.7）。
e)第五步。使用端口状态选择程序（8.6.11）。
f)步骤6。如果桥接器在配置更新后被选择为根，则
	1)步骤1。桥接器保持的Max Age、Hello Time和Forward Delay参数值为桥接器Max Age、桥接器Hello Time和桥接器Forward Delay的值。
	2)第二步。使用拓扑变化检测程序（8.6.14）。
	3)第三步。拓扑变更通知定时器（8.5.4.2）停止。
	4)第四步。使用配置BPDU生成过程（8.6.4），并启动Hello定时器。

8.8.5 Set Port Priority
a)步骤1。计算端口标识的新值。
b)第二步。如果端口已被选为LAN的指定端口（即指定网桥和指定端口参数的值分别与网桥标识符和端口标识符相同），则为该端口保存的指定端口参数将设置为端口标识符的新值。
c)步骤3。保存在端口上的端口标识符参数被设置为新的值。
d)第四步。如果端口的Designated Bridge参数值与桥接器的桥标识符值相等，并且新配置的端口标识符值比记录为指定端口的值优先级高，则
	1)步骤1。成为指定端口过程（8.6.10）用于为端口分配指定根、指定成本、指定网桥和指定端口参数的值。
	2)第二步。使用端口状态选择程序（8.6.11）。

8.8.6 Set Path Cost
a)步骤1。端口的路径开销参数设置为新的值。
b)第二步。使用配置更新流程（8.6.7）。
c)步骤3。使用端口状态选择程序。

8.8.7 Enable Change Detection
设置端口变化检测使能标志（8.5.5.10）。

8.8.8 Disable Change Detection
重置端口变化检测使能标志（8.5.5.10）。

8.9 Procedural model 
该子句构成了生成树算法和协议操作的最终描述。本标准8.6、8.7和8.8中的自然语言文本旨在非正式地给出这里指定的操作的语义。如果该案文和这一程序模式之间存在解释上的差异，则后者应优先。

8.9.1 Overview 
该协议的参数、定时器、过程元素和操作以计算机语言C （ANSI X3.159）的可编译程序形式在下面给出。
提出这个程序的目的是精确和明确地说明算法和协议的操作。用计算机语言描述本协议的操作，绝不意在限制本协议的实施；真正的实现可以采用任何适当的技术。

设备符合这个标准纯粹是在可观察协议方面。该子句中包含的程序包含与实现有关的局部建模细节；在这些细节方面没有一致性。
8.6、8.7和8.8中的自然语言文本遵循本子句中包含的计算机语言文本。
为了保持程序文本的紧凑性，所有注释都参考自然语言描述，形式为4.n.n.n。当程序语句调用过程的某个元素时，将进一步引用为过程列出的那些导致过程被调用的特定条件。
在过程模型的计算机语言描述中，应该注意到bpdu是以解包的形式显示的，即解包为单个参数。通过LLC服务边界传递的bpdu的实际格式如第9条所示。

/*CODE 省略，看源文档*/

8.10 Performance 
该子句对网桥局域网中网桥的性能以及生成树算法和协议的参数设置提出了要求。这些是确保算法和协议正确运行所必需的。
它建议为性能参数设置默认操作值。这些被指定是为了避免在操作之前需要设置值，并且被选择是为了最大限度地简化桥接局域网组件的互操作。
它指定性能参数的绝对最大值。指定适用值的范围是为了帮助选择操作值，并为实施者提供指导。

8.10.1 Requirements 
网桥局域网中的网桥参数和配置保证了正确的操作
—如果不需要重新配置，桥接器不会发起重新配置。这意味着桥接协议消息在后续消息到达之前不会超时，除非发生了故障。
—重新配置后，在新的主动拓扑上不转发帧，而在先前的主动拓扑上转发的帧仍然在桥接的局域网中。这确保了帧不会重复。

这些要求通过对进行限制来满足
—网桥LAN的最大网桥直径：终端站点任意两点间连接的最大网桥数。
-最大网桥传输延迟（maximum bridge transit delay）：转发的数据帧从接收到传输经过网桥的最大时间，如果超过这个时间，将被丢弃。
—最大BPDU传输延迟（maximum BPDU transmission delay）：桥接协议数据单元在需要传输BPDU之前的最大延迟时间，如8.7所示。
—对传输的bpdu报文的报文龄参数值或对存储的桥接协议报文信息的报文龄的最大报文龄增量的高估。
—桥的Hello Time、桥的Max Age、桥的Forward Delay和保持时间。

此外，桥梁不应
—低估发送的bpdu报文中消息年龄参数的增量。
-低估前向延迟。
-作为根节点时，高估了Hello时间间隔。

8.10.2 Parameter values
默认值、绝对最大值和参数取值范围如表8-1 ~表8-5所示。
对于桥的最大传输延迟、最大BPDU传输延迟和最大报文时间增量的高估，桥不能超过表8-2中规定的绝对最大值。
如果管理可以设置桥Hello Time、桥Max Age和桥前向延迟，则桥可以使用表8-3中参数范围内的所有值，粒度为1 s。

桥架应采用表8-3所示的保持时间值。
桥应加强下列关系：
2 × (Bridge_Forward_Delay – 1.0 seconds) >= Bridge_Max_Age
Bridge_Max_Age >= 2 × (Bridge_Hello_Time + 1.0 seconds)

建议每个网桥端口的路径代价参数默认值参照表8-5中的值，根据每个端口所在局域网段的速度来选择。
表8-5中的值适用于全双工和半双工操作。所示的推荐值和范围的目的是最小化桥接器的数量，其中需要管理路径成本，以便对桥接局域网的拓扑进行控制。

如果每个端口的网桥优先级和端口优先级都可以通过管理设置，则网桥有能力使用表8-4中参数范围内的全部优先级值，粒度为1。

网桥不应使用比8-5中指定的绝对最小值更低的与任何端口相关的路径成本参数值。
如果“路径代价”可以由管理设置，则该桥有能力使用表8-5中参数范围内的全部值，粒度为1。


9. Encoding of Bridge Protocol Data Units (BPDUs)
该子句指定了桥接协议实体之间交换的生成树协议的bpdu的结构和编码。

9.1 Structure
9.1.1 Transmission and representation of octets
所有bpdu都应该包含整数个字节。BPDU中的八位字节从1开始编号，按照放入DLSDU （Data Link Service Data Unit，数据链路服务数据单元）的顺序递增。八位组中的每一位从1到8编号，其中1是低阶位。
当连续使用八位组表示二进制数时，低八位组的值最高。
所有的桥接协议实体都遵守这些位和位的顺序约定，因此能够进行通信。

9.1.2 Components
在所有bpdu的初始字节中都编码了协议标识符。该标准保留一个协议标识符值。对于其他标准协议，如果存在协议标识符字段的不同值，则该标准对bpdu的结构、编码或使用没有进一步的限制。
操作第8条中指定的生成树算法和协议的桥接协议实体使用的bpdu使用保留的协议标识符值，结构如下。
每个BPDU都包含了协议运行所必需的固定数量的参数。每个参数编码为一个或多个字节，长度固定。BPDU中参数的顺序是固定的。
每个BPDU的参数由BPDU类型确定；所有相同类型的bpdu都应该包含相同的参数，以相同的顺序，以相同的方式编码。

9.2 Encoding of parameter types
9.2.1 Encoding of Protocol Identifiers
协议标识符应编码为两个字节。

9.2.2 Encoding of Protocol Version Identifiers
协议版本标识符应编码为一个字节。如果两个协议版本标识符解释为无符号二进制数，则较大的数字将关联到较新定义的协议版本。

9.2.3 Encoding of BPDU types
BPDU的类型应该被编码为一个单独的字节。八位组中包含的位模式仅用于区分类型。不同类型的bpdu之间没有顺序关系。

9.2.4 Encoding of flags
标志应编码为单个八位中的位。因此可以在一个八位字节中编码若干标志。如果字节组中对应的比特位的值为1，则设置一个标志。字节组中与给定类型BPDU定义的标志不对应的比特位将被重置，即设置为0。对于给定协议版本和类型的BPDU，不会定义额外的标志。

9.2.5 Encoding of Bridge Identifiers
桥接标识符应编码为八个字节，以表示无符号二进制数。可以用数字比较两个桥标识符，较小的数字表示优先级较高的桥。
桥标识符的两个最重要的八位组成一个可设置优先级组件，该组件允许管理桥的相对优先级（8.5.3.7和第14条）。最低的6个字节确保了桥标识符的唯一性；它们应根据以下程序从全局唯一的桥接地址（7.12.5）派生出来。
第三个最重要的字节来自MAC地址的第一个字节。将桥地址第一个比特位的最低有效位（第1位）赋值给桥地址的第一个比特位，将桥地址的第二个比特赋值给下一个最高有效位，以此类推。在一个使用48位MAC地址的桥接局域网中，第4到第8位被类似地分配桥接地址的第2到第6位的值。

9.2.6 Encoding of Root Path Cost
根路径代价应该被编码为四个八位，被用来表示一个无符号二进制数，任意代价单位的倍数。子句8.10.2包含了关于根路径成本增量的建议，以便在不需要桥接局域网中的桥接管理安装实践的情况下，可以对该参数设置一些通用值。

9.2.7 Encoding of Port Identifiers
端口标识符应编码为两个八位组，以表示无符号二进制数。如果用数字比较两个端口标识符，较小的数字表示优先级较高的端口。端口标识符的更重要的部分是一个可设置的优先级组件，它允许管理同一网桥上端口的相对优先级（8.5.5和第14条）。较低的字节是用无符号二进制数表示的端口号。不使用0作为端口号。

9.2.8 Encoding of Timer Values
定时器值应编码为两个八位组，表示无符号二进制数乘以1/256秒的时间单位。这允许表示0到256秒的时间，但不包括。

9.3 BPDU formats and parameters
9.3.1 Configuration BPDUs
bpdu的配置格式如图9-1所示。每个传输的配置BPDU应包含以下参数（8.5.1），不得包含其他参数：
a)协议标识符以BPDU的1和2字节编码。取值为0000 0000 0000 0000，表示第8条中指定的生成树算法和协议。
b)协议版本标识在BPDU的3字节中编码。它的取值为0000 0000。
c) BPDU类型编码为BPDU的4字节。该字段的值为0000 0000。这表示一个配置BPDU。
d)拓扑变化确认标志编码在BPDU的第5字节的第8位。
e)拓扑变化标志编码在BPDU的第5位的第1位。
f)根标识符以BPDU的6到13个字节编码。
g)根路径代价以BPDU的14 ~ 17个字节编码。
h)桥标识符以BPDU的18到25个字节编码。
i)端口标识以BPDU的26和27字节编码。
j) Message Age timer值以BPDU的28和29字节编码。
k)最大Age定时器值以BPDU的30和31字节编码。
l) Hello Time定时器值以BPDU中的32和33字节编码。
m)前向延迟定时器值编码为BPDU的34和35个字节。
消息年龄（28和29位）应小于最大年龄（30和31位）。

9.3.2 Topology Change Notification BPDUs
拓扑变化通知bpdu格式如图9-2所示。每个传输的拓扑变化通知BPDU应包含以下参数（8.5.2），不得包含其他参数：
a)协议标识符以BPDU的1和2字节编码。取值为0000 0000 0000 0000，表示本标准第8条中规定的生成树算法和协议。
b)协议版本标识在BPDU的3字节中编码。它的取值为0000 0000。
c) BPDU类型编码为BPDU的4字节。该字段的值为1000000（其中位8显示在序列的左侧）。这表示拓扑变化通知BPDU。

9.3.3 Validation of received BPDUs
桥接协议实体必须按照8.7的规定处理收到的BPDU，当且仅当该BPDU包含至少4个字节且协议标识符具有为BPDU指定的值（9.3.2）和
a) BPDU类型表示配置BPDU，该BPDU至少包含35个字节，BPDU Message Age参数的值小于其Max Age参数的值；或
b) BPDU类型表示拓扑变化通知BPDU。
在情况a)中，根据本标准进行处理时，任何存在于8位字节35以外的8位字节都会被忽略。类似地，在情况b)中，任何超过4位的字节都会被忽略。
注意：接收协议时不会检查协议版本标识符，以便将来扩展生成树协议时，可以通过协议版本标识符的不同值来识别新版本。
















